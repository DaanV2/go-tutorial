# Golang Server

We are going to use the `http` package to create a simple server that serves a static file.

## Setup

First, add a new subcommand with cobra-cli:

```bash
cobra-cli add server
```

## Walkthrough

### 1. Create a server

In the `cmd/server.go` file, we are going to create a new server that serves a static file.

```go
package cmd

import (
    "net/http"

    "github.com/spf13/cobra"
)

// serverCmd represents the server command
var serverCmd = &cobra.Command{
    Use:   "server",
    Short: "Start a server",
    Run: serverWorkload,
}

func init() {
	rootCmd.AddCommand(serverCmd)
}

func serverWorkload(cmd *cobra.Command, args []string) {

}
```

### 2. Basic server

We are going to create a basic server that serves a static file.

```go
func serverWorkload(cmd *cobra.Command, args []string) {

    router := http.NewServeMux()
    router.Handle("/", http.FileServer(http.Dir("./static")))

    server := http.Server{
        Addr: ":8080",
        Handler: router,
    }

    fmt.Println("Server started at ", server.Addr)
    defer fmt.Println("Server closed")
    err := server.ListenAndServe()
    if err != nil {
        fmt.Println(err)
    }
}
```

### 3. Test the server

Now we can test the server by running and then opening the browser at `http://localhost:8080`.

```bash
go run main.go server
```

### 4. Waiting for a shutdown signal

We can wait for a shutdown signal to close the server gracefully. But first, we need to move the serve listener to a goroutine. This will allow us to listen for signals while the server is running.

We also use .Shutdown() to gracefully shutdown the server. Which will close anything that is not sending requests. Normally, clients or browsers will keep the connection open for a while. And may send requests over that connection.

We gracefully shutdown getting rid of any connections that are not sending requests. This will also block all new requests/connections.

After that we do a hard close with .Close() to close the server.
In prod you would probably want to do a hard close after a certain amount of time. But for this example, we are just going to do it right away.

```go
go func() {
    fmt.Println("Server started at ", address)
    defer fmt.Println("Server closed")

    if err := server.ListenAndServe(); err != nil {
        if !errors.Is(err, http.ErrServerClosed) {
            fmt.Println("Server error: ", err)
        }
    }
}()

// Await for signal to close server
signals := make(chan os.Signal, 1)
signal.Notify(signals, syscall.SIGINT, syscall.SIGTERM, syscall.SIGQUIT)

<-signals
fmt.Println("Server is shutting down")

// Graceful shutdown
err := server.Shutdown(context.Background())
if err != nil {
    fmt.Println("Error while shutting down server: ", err)
}
if err := server.Close(); err != nil {
    fmt.Println("Error while closing server: ", err)
}
```

### 5. Test the server

Now we can test the server by running and then opening the browser at `http://localhost:8080`.

```bash
go run main.go server
```

Then hit `ctrl+c` in the terminal.

### 6. Add an api endpoint

We are going to add an api endpoint that returns a timestamp. This will work with the button in the static file.

```go
router.HandleFunc("/api/timestamp", func(w http.ResponseWriter, r *http.Request) {
    w.WriteHeader(http.StatusOK)
    d := time.Now().Format(time.RFC3339)

    _, err := w.Write([]byte(d))
    if err != nil {
        fmt.Println("Error while writing response: ", err)
    }
})
```

Dont forget to test it!

### 7. Logging Middleware

Middleware is a way to wrap around the request and response. This allows you to do things like logging, authentication, etc. And sits between the server object and the route handlers

```go
type Logger struct {
	Next http.Handler
}

func (l *Logger) ServeHTTP(w http.ResponseWriter, r *http.Request) {
	fmt.Printf("[%s] %s %s\n", time.Now().Format(time.DateTime), r.Method, r.URL.Path)
	l.Next.ServeHTTP(w, r)
}
```

Then patch the server object with the middleware:

```go
server := http.Server{
    Addr: ":8080",
    Handler: &Logger{Next: router},
}
```